#!/bin/bash

# Exit on any error
# Thanks MC!
set -e
set -x

if [[ -z $1 ]]; then
  echo "Must specify main java class e.g. com.flightstats.hub.app.SingleHubMain"
  exit 2
fi

# Determine deploy dir and chdir to that directory,
# then source the config to get user info
#
APP=hub
APP_HOME=/opt/$APP
CONF_DIR=/etc/$APP
HUB_PORT=80
DEBUG_PORT=3333
JMXREMOTE_PORT=8888
MAIN_CLASS=${1}
MIN_HEAP=${2:-256m}
MAX_HEAP=${3:-512m}
MIN_NEW=${4:-10m}

if [[ $MAIN_CLASS == "com.flightstats.hub.app.HubMain" ]]; then
  CONFIG="${CONF_DIR}/${APP}.properties"
  HUB_PORT=8080
else
  CONFIG=""
fi

JAVA_OPTS="
 $JAVA_OPTS
 -d64
 -server
 -Xmx$MAX_HEAP
 -Xms$MIN_HEAP
 -XX:NewSize=$MIN_NEW
 -XX:+UseG1GC
 -XX:MaxGCPauseMillis=100
 -Dsun.rmi.dgc.client.gcInterval=300000
 -Dsun.rmi.dgc.server.gcInterval=300000
 -agentlib:jdwp=transport=dt_socket,address=$DEBUG_PORT,server=y,suspend=n
 -Djboss.platform.mbeanserver
 -Dcom.sun.management.jmxremote
 -Dcom.sun.management.jmxremote.port=$JMXREMOTE_PORT
 -Dcom.sun.management.jmxremote.ssl=false
 -Dcom.sun.management.jmxremote.authenticate=false
 -XX:+PrintGCDetails
 -XX:+PrintTenuringDistribution
 -XX:+PrintGCDateStamps
 -Djava.awt.headless=true
 -Dsun.net.inetaddr.ttl=0
 -Xloggc:/mnt/log/gc.log-$(date -u '+%Y-%m-%d-%H-%M-%S')
 -Dfile.encoding=UTF-8
 -Dapp.url=http://localhost/
 -Dhttp.bind_port=${HUB_PORT}
 -Dalert.run=true
 -Dapp.stable_seconds=2
 -Ddata_dog.enable=false
 -Dlogback.configurationFile=/etc/${APP}/logback.xml"

CHILDPID=""
function shutdownChild()
{
        echo signal trap caught - taking stack trace and sleeping 5s before relaying signal

        if [ -z "$CHILDPID" ]
        then
                echo no hub child PID to shutdown
                return
        fi

        kill -QUIT $CHILDPID

        echo issuing shutdown curl command...
        curl -is -X POST http://localhost:${HUB_PORT}/shutdown

        kill -TERM $CHILDPID
        echo signal sent, waiting ...
        wait $CHILDPID
        echo hub is down
}
trap "shutdownChild" SIGTERM SIGINT

echo running hub in the background...
exec java -cp $(ls ${APP_HOME}/lib/${APP}-*):${APP_HOME}/lib/* $JAVA_OPTS $MAIN_CLASS $CONFIG &
CHILDPID=$!
echo "... hub pid is $CHILDPID"

wait $CHILDPID
exit $?
